# Архитектура проекта «Batumi Trip»
> **Контекст**: небольшое Single Page Application для 10 друзей, позволяющее совместно собирать и обсуждать локации для будущего путешествия  — см. UserStory-BatumiTrip.md документ.

---
## 1. Технологии
| Инструмент / Библиотека | Роль в проекте |
|-------------------------|----------------|
| **Next.js 14** - App Router; React 18; Server Components и Client Components | **Frontend** - UI‑рендеринг страниц и компонентов; Маршрутизация (динамические маршруты, nested routing); Адаптивная верстка под мобильные и десктоп устройства |
| **Tailwind CSS** + **shadcn** | **CSS-фреймворк и UI-компоненты** - Утилитарные классы для быстрого стилирования; Готовые дизайн-компоненты (кнопки, карточки, формы) для согласованного UI|
| **lucide-react** | **Иконки** - Лёгкий SVG-иконопакет |
| **Framer Motion** | **Анимации** - Плавные переходы и визуальные эффекты; Анимация мерцания skeleton-loader, появления карточек |
| **Supabase** - PostgreSQL база данных; Storage (загрузка и хранение изображений); Row-Level Security; Supabase Auth (Magic Link); Edge Functions | **Backend-as-a-Service** - Надёжное хранение данных и управление доступом (RLS); Готовый API для CRUD операций; Аутентификация пользователей; Серверные функции на Edge для дополнительной логики (геокодинг, вебхуки) |
| **Vercel** | **Хостинг, CI/CD** - Автоматический деплой при коммитах в main/dev; Управление переменными окружения |
| **React Query** | **Удалённые данные** - Запросы к Supabase API; Кэширование и фоновые обновления (revalidation); Optimistic UI при мутациях |
| **Zustand** + **Context API** | **Глобальный стэйт** - Управление UI‑состоянием (фильтры, модалки, избранное); Лёгкая замена Redux для простых кейсов |
| **NextAuth.js** | **Аутентификация** - Вход по логину без пароля; провайдер Credentials; генерация и валидация user ID; интеграция с middleware и cookie‑сессией |
| **Next.js Middleware** | **Защита маршрутов** - Проверка наличия HTTP‑only cookie с user ID; редирект на страницу логина; контроль доступа к приватным страницам |
| **HTTP‑only Cookie** | **Session Management** - Хранение user ID в безопасном cookie; долговременная сессия без пароля; автоматический рефреш при навигации |

---
## 2. Локальная структура директорий
```text
batumi‑trip/
├─ app/                   
│   ├─ layout.jsx         # глобальный layout
│   ├─ page.jsx           # лэндинг со списком локаций
│   ├─ api/               # App Router API routes
│   │   └─ auth/          
│   │       └─ [...nextauth]/route.js   # NextAuth.js endpoints
│   └─ locations/
│       ├─ new/page.jsx   # форма добавления
│       └─ [id]/page.jsx  # детальная страница локации
├─ middleware.ts          #	auth‑middleware (NextAuth.js + cookie)
├─ components/      
│   ├─ AuthProvider.js    # Обёртка SessionProvider (NextAuth)
│   ├─ LoginModal.js      # Модальное окно входа без пароля
│   ├─ Providers.js       # Композиция провайдеров (React Query, Auth, Theme)
│   ├─ ThemeProvider.js   # Провайдер тем (next-themes)
│   ├─ ...
│   └─ ui/                # radix-ui компонентый через shadcn
│       ├─ button.jsx
│       ├─ dialog.jsx
│       ├─ input.jsx
│       └─ ...
├─ lib/
│   ├─ reactQuery.js     # Конфигурация и создание клиента React Query           
│   ├─ supabaseClient.js # Инициализация и экспорт клиента Supabase
│   ├─ utils.js          # Утилиты для объединения и оптимизации CSS-классов 
│   ├─ auth.js           # NextAuth options (не реализован)
│   ├─ cookies.js        # утилиты для работы с куками (не реализован)
│   └─ fetchers.js       # (не реализован)
├─ hooks/                 
│   ├─ useAuth.js        # Хук работы с сессией и методами входа/выхода
│   └─ useLocations.js   # (не реализован)
├─ store/                # Zustand сторы и селекторы
│   └─ uiStore.js        # Zustand-хранилище UI
├─ styles/                
│   ├─ globals.css
│   └─ tailwind.config.js
├─ public/               # статичные ассеты           
├─ supabase/             # миграции, SQL‑скрипты, RLS‑политики
├─ .env.example           
└─ README.md
```

---
## 3. State-management

| Тип состояния | Инструмент | Роль в проекте |
|---------------|------------|----------------|
| **Auth‑сессия** | **NextAuth.js + Middleware + Cookie** | Управление сессией пользователя: при первом входе сохраняется только логин (без пароля) в виде cookie‑ID, Middleware проверяет и восстанавливает сессию на всех маршрутах. |
| **Удалённые данные** | **React Query** | Управление состоянием данных с сервера: асинхронные запросы, кэширование, автоматическое обновление и синхронизация данных с сервером. |
| **Глобальный UI-стэйт** | **Zustand** | Управление состоянием пользовательского интерфейса: хранение и управление состоянием, связанным с UI, таким как открытие и закрытие модальных окон, фильтры, избранное и другие элементы UI. |
| **Глобальный UI-стэйт** | **Context API** | Инъекция зависимостей: предоставление глобальных значений, таких как тема приложения или текущий язык, доступных в любом месте приложения. |
| **Локальный стэйт** | **useState / useReducer**  | Управление локальным состоянием компонентов: значения форм, индикаторы загрузки и другие временные состояния, обеспечивающие независимость и тестируемость компонентов. |

---
## 4. Сущности базы данных
> Ниже приведено описание основных таблиц базы данных для SPA‑приложения «Batumi Trip», реализованного на Supabase. Архитектура учитывает бесшовную аутентификацию без пароля (passwordless) через NextAuth.js, хранение пользовательских сессий в HTTP‑cookie и разграничение прав на уровне записей. Таблицы спроектированы для удобного хранения информации о локациях, их тегах и связи с пользователями.

### Таблица `users`
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | `VARCHAR(50)` | Логин пользователя — единственный идентификатор (PK). Генерируется при первом входе. |
| `created_at` | `TIMESTAMP` | Дата и время создания записи |
| `updated_at` | `TIMESTAMP` | Дата и время последнего обновления |

**Аутентификация**  
- Passwordless: при первом входе пользователь вводит только логин, пароль не используется и не хранится.  
- NextAuth.js middleware создает сессию и сохраняет её в HTTP‑cookie.  

### Таблица `locations`
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | `UUID` | Уникальный идентификатор локации (PK)                                 |
| `user_id` | `VARCHAR(50)` | Логин пользователя — внешний ключ на `users.id`, определяет владельца записи |
| `title` | `TEXT` | Название или заголовок локации |
| `description` | `TEXT` | Подробное описание |
| `image_url` | `TEXT` | URL изображения |
| `address` | `TEXT` | Адрес (улица или GPS‑координаты) |
| `cost` | `TEXT` | Стоимость (например, `"50 GEL"`, `"бесплатно"`) |
| `source_url` | `TEXT` | Ссылка на источник или официальный сайт |
| `created_at` | `TIMESTAMP` | Дата и время создания записи |
| `updated_at` | `TIMESTAMP` | Дата и время последнего обновления |
> **Контекст использования**  
> - При рендеринге списка локаций `LocationList` загружается через infinite scroll.

### Таблица `tags`
| Поле | Тип | Описание |
|------|-----|----------|
| `id` | `UUID` | Уникальный идентификатор тэга (PK) |
| `name` | `VARCHAR(50)` | Текстовое название тэга |
> **Контекст использования**  
> - Теги применяются для фильтрации локаций и отображения в LocationCard.

### Таблица `favourites`

| Поле | Тип | Ключи/DEFAULT | Описание |
|------|-----|---------------|----------|
| `user_id` | `VARCHAR(50)` | **PK (часть)**, **FK → users.id** | Пользователь, который добавил в избранное. |
| `location_id` | `UUID` | **PK (часть)**, **FK → locations.id** | Избранная локация. |
| `created_at` | `TIMESTAMP WITH TIME ZONE` | `DEFAULT now()` | Дата добавления в избранное. |

### Связующая таблица `locations_tags`
| Поле | Тип | Описание |
|------|-----|----------|
| `location_id`| `UUID` | Внешний ключ на `locations.id` |
| `tag_id` | `UUID` | Внешний ключ на `tags.id` |
> **Контекст использования**  
> - При добавлении/удалении тега в карточке локации обновляется эта таблица через Supabase RPC-функции или клиентский SDK.  

**Индексы и производительность**  
| Таблица | Индекс |
|---------|--------|
| `locations` | `idx_locations_user` (`user_id`) `idx_locations_title_trgm` `USING GIN(title gin_trgm_ops)`|
| `locations_tags` | `idx_locations_tags_tag` (`tag_id`) |
| `favourites` | `idx_favourites_user` (`user_id`) `idx_favourites_location` (`location_id`) |
| `tags` | `UNIQUE (name)` |
- Автоматическое проставление `created_at` и `updated_at` через триггеры в Supabase.  

---