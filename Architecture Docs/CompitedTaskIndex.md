# Документ отслеживание контрольных точке и задач из RoadMap-BatumiTrip (дополняет ExistComponents.md)

## Индекс Таблица с кратким обзором состояния проекта

| ID | Спринт | Статус | Последнее обновление |
|----|--------|--------|----------------------|
| 1 | S0. Подготовка инфраструктуры и каркас | Завершено | 2025-05-06 |
| 2 | S1. Реализация аутентификации и главной страницы: логин без пароля, отображение списка локаций | Необходимы правки | 2025-05-07 |
| 3 | S2. Функция добавления локации: страница *AddLocation*, форма, сохранение в БД (локи+теги) | В процессе выполнения | - |

---
## Краткие отчёты о выполненном задании

### S0. Подготовка инфраструктуры и каркас. **Task ID 1** 

### S0-01 Инициализация репозитория и каркаса
| Дата       | Ответственный | Статус     |
|------------|---------------|------------|
| 2025-05-06 | Vadim         | ✅ Завершено |

**Выполнено:**
1. Сгенерирован проект **Next.js 14.2.5** с App Router, ESLint и Tailwind CSS (флаг `--tailwind`) согласно Architecture-BatumiTrip.md
2. Установлены зависимости:  
   - фреймворки и хелперы (NextAuth.js, Supabase JS),  
   - стейт-менеджмент (React Query, Zustand),  
   - UI-библиотеки (shadcn, lucide-react, framer-motion, clsx, tailwind-merge, tailwindcss-animate)
3. Создана структура директорий:  
   `app/`, `components/`, `hooks/`, `lib/`, `store/`, `styles/`, `supabase/`, `tests/`
4. Настроен `tailwind.config.js`:  
   `darkMode: 'class'`, дизайн-токены цветов (primary, secondary, background, foreground) из StyleGuide-BatumiTrip.md
5. Написан `styles/globals.css` с подключением `@tailwind`-блоков и CSS-переменными для светлой/тёмной темы
6. Реализованы провайдеры в `components/Providers.js`: (код см. ComponentsDesign-BatumiTrip.md)
   обёртка `<QueryClientProvider>` (React Query), `<AuthProvider>` (NextAuth) и `<ThemeProvider>` (next-themes)
7. Сгенерированы базовые JS-файлы: (код см. ComponentsDesign-BatumiTrip.md)
   - **app/layout.js** — глобальный Layout с `<Providers>`;  
   - **app/page.js** — тестовая страница для проверки компонентов и логики;  
   - **lib/reactQuery.js** — создание `QueryClient`;  
   - **lib/supabaseClient.js** — инициализация клиента Supabase;  
   - **hooks/useAuth.js** — хук для авторизации;  
   - **store/uiStore.js** — Zustand-стор для UI (searchQuery, selectedTags, favourites и т.д.);  
   - **middleware.ts** и **app/api/auth/[...nextauth]/route.js** — безпарольный вход и защита маршрутов.

> **Acceptance Criteria:**  
> - `npm run dev` стартует приложение без ошибок сборки.  
> - Тема переключается корректно: классы `bg-background` / `text-foreground` меняются при `class="dark"` на `<html>`.  
> - Тестовая страница отображает текущее время из Supabase RPC, корректно рендерит провайдеры, Zustand и React Query.  
> - Локальная структура директорий соответствует спецификации в Architecture-BatumiTrip.md
> - Базовые файлы и компоненты готовы к дальнейшему развитию по ComponentsDesign-BatumiTrip.md и StateManagement-BatumiTrip.md.

---
### S0-02 Настройка Supabase и миграций
| Дата       | Ответственный | Статус      |
|------------|---------------|-------------|
| 2025-05-06 | Vadim         | ✅ Завершено |

**Выполнено:**
1. Создан проект Supabase (Free-tier), привязка через `supabase link`.  
2. Добавлены миграции: (sql код см. DataModel-BatumiTrip.md , 4. Миграции (SQL))
   - Расширения (`pgcrypto`, `pg_trgm`), триггер `trigger_set_timestamp`.  
   - Таблицы `users`, `locations`, `tags`, `locations_tags`, `favourites`.  
   - Индексы для ускорения выборок и поиска.  
   - RLS-политики для обеспечения безопасности на уровне строк.  
3. Выполнен `supabase db push`, проверена корректность схемы в Dashboard.  
4. Настроены env-переменные для работы SDK и NextAuth.

> **Acceptance Criteria:** в Supabase-UI отображаются все таблицы с нужными полями и связями; RLS-политики активны; приложение при старте без ошибок может выполнять запросы к `/rest/v1/{table}`.  

---
### S0-03 Настройка password‑less аутентификации NextAuth + Supabase
| Дата       | Ответственный | Статус        |
|------------|---------------|---------------|
| 2025-05-06 | Vadim         | ✅ Завершено  |

**Выполнено:**
1. Добавлен Credentials Provider без пароля в NextAuth
2. Реализован upsert записи пользователя в таблицу `users` Supabase при authorize
3. Сконфигурированы сессии JWT (strategy: “jwt”, maxAge 30 дней) и HTTP‑only cookie
4. Написан middleware в `middleware.ts` для проверки JWT‑cookie и редиректа на `/` при отсутствии сессии; настроен matcher для `/locations/:path*`

> **Acceptance Criteria:**  
> - После входа через Credentials Provider в Supabase появляется запись в таблице `users`.  
> - JWT хранится в HTTP‑only cookie `next-auth.session-token` (или `__Secure-next-auth.session-token` в prod).  
> - При обращении к приватным маршрутам `/locations/*` без валидной сессии выполняется редирект на `/`.  
> - Приложение без ошибок выполняет запросы к защищённым API при наличии сессии.  

---
### S1. Реализация аутентификации и главной страницы: логин без пароля, отображение списка локаций. **Task ID 2** 

### S1-01 LoginModal и обновлённый route.js
| Дата       | Ответственный | Статус      |
|------------|---------------|-------------|
| 2025-05-06 | Vadim         | ✅ Завершено |

**Выполнено:**
- Компонент `LoginModal` (shadcn/ui Dialog, Tailwind, Framer Motion, Zustand)  
- Обновлён `route.js` NextAuth Credentials + Supabase upsert + RLS  
- Проверена вставка в `users` и закрытие модалки при авторизации 

---
### S1-02 Header.js: UI и функционал
| Дата       | Ответственный | Статус      |
|------------|---------------|-------------|
| 2025-05-06 | Vadim         | ✅ Завершено |

**Выполнено:**
1. Добавлен компонент `Header` в `components/Header.js` по описанию из ComponentsDesign: отображение логотипа, кнопок «Войти»/«Выйти» и пользовательского имени  
2. Реализована анимация появления (slide-down + fade-in) через Framer Motion при монтировании компонента  
3. Интегрирован `useAuth` (NextAuth) для кнопки «Выйти» и `useUIStore` (Zustand) для показа/скрытия `LoginModal` при клике на «Войти»

> **Acceptance Criteria:**  
> - `Header` отображается на главной странице;  
> - При загрузке страницы видна анимация slide-down + fade-in;   
> - Логотип кликабельный и ведёт на `/`;  
> - Кнопка «Войти» открывает `LoginModal`, «Выйти» — завершает;

---
### S1-03 Реализация блока главной страницы LocationListPage
| Дата       | Ответственный | Статус      |
| ---------- | ------------- | ----------- |
| 2025-05-06 | Vadim         | ✅ Завершено |

**Выполнено:**
1. **useLocations** (hooks/useLocations.js):
   * Реализован кастомный хук на базе `useInfiniteQuery` и Supabase JS SDK с cursor-pagination по полю `created_at`.
   * Добавлена фильтрация по `searchQuery` и выбранным тегам из Zustand-стора
2. **LocationList** (components/LocationList.js):
   * Подключение `useLocations()` для загрузки страниц локаций.
   * Skeleton-заглушки при первичной загрузке и докрутке (`SkeletonCard`).
   * Бесконечная прокрутка через `IntersectionObserver` на «сенсоре».
   * Сетка `grid-cols-1/2/3
3. **AddLocationButton** (components/AddLocationButton.js):
   * Кнопка-ссылка на `/locations/new` с иконкой `Plus` (lucide-react) и компонентом `Button` из shadcn.
   * Адаптивное позиционирование FAB (mobile-first) по макету.
4. Добавлены временные стабы **LocationCard** и **SkeletonCard**, чтобы страница собиралась и рендерилась без ошибок до финальной верстки карточек.

> **Acceptance Criteria:**
> * На маршруте `/` отображаются `LocationList` с корректной подгрузкой и Skeleton-плейсхолдерами, `AddLocationButton`.
> * Сборка приложения проходит без ошибок; подгрузка и бесконечный скролл рабочих страниц локаций.

---
### S1-04 Реализация карточек локаций
| Дата       | Ответственный | Статус      |
|------------|---------------|-------------|
| 2025-05-07 | Vadim    | ✅ Завершено |

**Выполнено:**
1. Спроектированы и реализованы два отдельных компонента:  
   - **SkeletonCard** — анимированный плейсхолдер при загрузке списка (`animate-pulse`, скелетные блоки под изображение, заголовок и теги).  
   - **LocationCard** — финальная карточка локации с фото, заголовком, усечённым описанием и списком тегов (TagBadge).  
2. Убрана недоработанная логика `useToggleFavourite` — кнопка «звезда» оставлена статичной до реализации хука.  
3. Верстка соответствует StyleGuide (округлые углы, тени, mobile‑first, адаптивные размеры), добавлены hover/focus эффекты и лёгкая анимация появления через Framer Motion.  
4. Компоненты покрыты мемоизацией (`React.memo`) для предотвращения лишних рендеров.  

> **Acceptance Criteria:**  
> - При загрузке списка показываются `SkeletonCard`.  
> - После получения данных отображаются `LocationCard` с корректным отображением всех полей.

---
### S1-05 Реализация TagBadge, useTags и обновление useLocations
| Дата       | Ответственный | Статус      |
| ---------- | ------------- | ----------- |
| 2025-05-07 | Vadim        | ✅ Завершено |

**Выполнено:**
1. **TagBadge**
   * Создан компонент отображения тега с Tailwind-стилями и опциональной анимацией через Framer Motion.
   * Реализована поддержка клика: при передаче `onClick` бейдж получает role="button" и вызывает переданную функцию.
2. **useTags**
   * Добавлен хук `useTags` на основе React Query и Supabase для выборки всех тегов (`tags`) с кэшированием 5 минут.
3. **useLocations**
   * Модифицирован `hooks/useLocations.js`: в запросе Supabase включена вложенная связь `locations_tags(tags.name)` для получения массива имён тегов
   * После получения данных выполнено мапирование, формирующее поле `tags: string[]` в каждом объекте локации.
4. **Интеграция в LocationCard**
   * Внутри `LocationCard` вместо заглушки выводятся `<TagBadge>`-ы, получая массив `tags` из `useLocations`.
5. **Тестирование**
   * Проверена отрисовка бейджей, эффекты hover/tap.
   * Подтверждена корректная фильтрация по тегам без полной перезагрузки списка.

> **Acceptance Criteria:** в карточках локаций отображаются теги в виде бейджей;

---

### S1-06 Реализация поиска в Header и компонент SearchBar
| Дата       | Ответственный | Статус      |
| ---------- | ------------- | ----------- |
| 2025-05-07 | Vadim         | ✅ Завершено |

**Выполнено:**
1. Вынесена логика поля поиска в компонент **SearchBar** (`components/SearchBar.js`), согласно описанию из ComponentsDesign: placeholder, debounce 1000 мс, синхронизация с Zustand через `useUIStore.setSearchQuery` .
2. Модифицирован **Header** (`components/Header.js`), чтобы показывать рядом с логотипом иконку поиска (`<Search />` из `lucide-react`), по клику на которую через локальный `isSearchOpen` разворачивается область с `<SearchBar />`. Анимация появления/сворачивания реализована через `AnimatePresence` + Framer Motion .
3. Добавлены стили Tailwind и утилита `cn` для устранения дублирования классов и соответствия StyleGuide (скругления, отступы, фокус-стили) .

> **Acceptance Criteria:**
> * В шапке отображается иконка поиска рядом с логотипом и кнопками авторизации.
> * При клике поле поиска плавно разворачивается и фокусируется.
> * Ввод текста обновляет `searchQuery` в Zustand через 1000 мс debounce.

---
### S2-01 Реализация страницы добавления локации
| Дата       | Ответственный | Статус      |
| ---------- | ------------- | ----------- |
| 2025-05-08 | Vadim         | ✅ Завершено |

**Выполнено:**
1. Добавлен хук `useAddLocation` (hooks/useAddLocation.js):
   * Интеграция с NextAuth: получение `user_id` из сессии и передача в payload.
   * Вставка записи в таблицу `locations` с полями `user_id`, `title`, `description`, `address`, `cost`, `source_url`, `image_url`.
   * Инвалидация кешей React‑Query для `['locations']` и `['tags']`.
2. Создан компонент `LocationForm` (components/LocationForm.js):
   * Поля: заголовок, описание, адрес, стоимость, ссылка, теги (заглушка).
   * Валидация обязательного поля title через React Hook Form.
   * При сабмите вызывает `mutation.mutate` и перенаправляет на страницу новой локации.
3. Реализована страница добавления `/locations/new/page.js`:
   * Рендерит заголовок и `LocationForm` без `initialData`.
   * Использует Tailwind и shadcn‑компоненты для стилизации.

> **Acceptance Criteria:**
> * При авторизованном пользователе новая локация создаётся с корректным `user_id` в Supabase.
> * После создания происходит редирект на `/locations/{id}`.

---
### S2-02 Реализация выбора тегов и интеграция RPC
| Дата       | Ответственный | Статус      |
| ---------- | ------------- | ----------- |
| 2025-05-09 | Vadim         | ✅ Завершено |

**Выполнено:**
1. Разработан компонент `ChooseTag.js`:
   * подгрузка существующих тегов через `useTags()`;
   * выбор/снятие тегов кликом;
   * добавление нового тега с записью в таблицу `tags`;
   * устранена вложенная форма, заменена на `<div role="form">`, реализована обработка Enter.
2. Обновлён хук `useAddLocation.js`:
   * явное извлечение `tags` из `formData` и нормализация в `string[]`;
   * вызов RPC-функции `create_location_with_tags`
3. Модифицирован `LocationForm.js`
   * подключение `ChooseTag` для работы с массивом тегов;
   * установка `defaultValues.tags = []`;
   * передача массива тегов и остальных полей в мутацию.

> **Acceptance Criteria:**
> * При submit формы вызывается RPC `create_location_with_tags` с корректным массивом тегов.
> * В таблице `tags` добавляются новые теги (если нужны), в `locations_tags` создаются связи.
> * Форма отправляется без ошибок, компонент `ChooseTag` работает согласно UI-требованиям.

---
### S2-03 Реализация загрузки изображений в LocationForm
| Дата       | Ответственный | Статус      |
|------------|---------------|-------------|
| 2025-05-09 | Vadim         | ✅ Завершено |

**Выполнено:**
1. Создан компонент `AttachImage.js` с интеграцией React Hook Form, позволяющий:
   - загрузить ровно одно изображение;
   - скрывать file‑input после выбора;
   - отображать превью с кнопкой «крестик» для отмены и повторной загрузки.  
2. Внедрён `AttachImage` в `LocationForm.js` вместо стандартного `<Input type="file">`, передающего `control` и поле `imageFile` в форму.  
3. Обновлён хук `useAddLocation` (hooks/useAddLocation.js) для:
   - чтения `NEXT_PUBLIC_SUPABASE_BUCKET` из окружения;
   - загрузки файла из переданного `FileList` в Supabase Storage и получения publicUrl;
   - передачи полученного `image_url` в RPC-вызов `create_location_with_tags`.  
4. Проверена корректность передачи `FileList` из формы в мутатор, загрузки в бакет и сохранения `image_url` в таблицу `locations`.  

> **Acceptance Criteria:**  
> - При создании новой локации из формы изображение загружается в Supabase Storage (правильный бакет);  
> - В таблице `locations` поле `image_url` содержит публичный URL загруженного файла;  
> - При отмене превью файл можно загрузить заново.  

---
### S3-01 Реализация обновления локации и тегов
| Дата       | Ответственный | Статус      |
| ---------- | ------------- | ----------- |
| 2025-05-10 | Vadim         | ✅ Завершено |

**Выполнено:**
1. В SQL‑миграциях добавлена функция `update_location_with_tags`, которая атомарно:
   * Обновляет поля в таблице `locations`.
   * Удаляет старые связи в `locations_tags`.
   * Вставляет новые теги в `tags` (если их ещё нет) и создаёт связи в `locations_tags`.
2. Реализован клиентский хук `useUpdateLocation`:
   * Вызывает RPC `update_location_with_tags` через `supabase.rpc(...)`.
   * При успешном обновлении инвалидирует кэши `['location', id]` и `['locations']` для актуализации данных.
   * Обрабатывает ошибки через `toast.error`.
3. Обновлён компонент `LocationForm` для поддержки двух режимов в одном:
   * Определение режима по наличию `initialData.id`.
   * В режиме редактирования вызывает `useUpdateLocation`, в режиме создания — `useAddLocation`.
   * После успешного сабмита перенаправляет на `LocationDetail`.

> **Acceptance Criteria:**
> * При редактировании существующей локации все изменения полей и тегов сохраняются корректно, без ошибок CTE.
> * Новые теги автоматически создаются и связываются с локацией.
> * UI мгновенно отражает обновлённые данные благодаря рефрешу React Query.
> * Форма корректно переключается между режимами «Создать» и «Редактировать» на основании `initialData.id`.

---
### S3-02 Исправление загрузки и отображения изображений
| Дата       | Ответственный | Статус      |
|------------|---------------|-------------|
| 2025-05-10 | Vadim         | ✅ Завершено |

**Выполнено:**
1. **lib/uploadImage.js**  
   – Реализована утилита загрузки файла в Supabase Storage с sanitization пути (только латиница, цифры, `_` и `-`), генерацией уникального имени, получением publicUrl и выбросом ошибок при неудаче.  
2. **AttachImage.js**  
   – Передача одиночного `File` вместо `FileList`; корректное создание и освобождение preview URL; очистка input при удалении картинки.  
3. **LocationForm.js**  
   – Унификация контракта формы: поля `imageFile` и `imgUrl`; в режиме редактирования сохранение старого URL при отсутствии нового файла; передача четкого payload в мутации.  
4. **useAddLocation.js** & **useUpdateLocation.js**  
   – Интеграция `uploadImage`; нормализация массива тегов; обработка ошибок загрузки через `toast.error`; передача корректного `image_url` в RPC; инвалидация кеша React Query.

> **Acceptance Criteria:**  
> - При создании и редактировании локации файл успешно загружается в Storage, в БД записывается корректный публичный URL или `NULL`.  
> - UI не падает с ошибкой `InvalidKey` или `next/image`, используется резервное изображение при отсутствии/ошибке URL.  
> - Мутации работают с нормализованными тегами и дают пользователю понятные `toast`-уведомления об ошибках и успехе.  

---

### S3-02 Реализация удаления локации
| Дата       | Ответственный | Статус      |
|------------|---------------|-------------|
| 2025-05-10 | Vadim         | ✅ Завершено |

**Выполнено:**
1. Написана RPC-функция `delete_location` для удаления записи из таблицы `locations` и связанных записей в `locations_tags`.  
2. Создан хук `useDeleteLocation` (hooks/useDeleteLocation.js) с React Query:
   - Выполняет вызов RPC `delete_location`.  
   - Удаляет связанные записи в `favourites`.  
   - Удаляет файл изображения через `deleteImage`.  
   - Инвалидирует кеши `locations` и `favourites`, сбрасывает флаг избранного в Zustand и отображает toast.  
3. Обновлена страница `app/locations/[id]/page.jsx`:
   - Определяется `canEdit = user.id === location.user_id`.  
   - Кнопка *Удалить* отображается только для автора.  
   - При клике показывается `window.confirm`, затем вызывается мутация и по успеху `router.push('/')`.  
4. Компонент `LocationDetail.jsx` очищен от логики удаления (оставлена только кнопка «Назад»).

> **Acceptance Criteria:**  
> - Только автор видит и может нажать «Удалить».  
> - После подтверждения и успешного удаления: локация исчезает из БД и тегов, удаляется изображение из Storage, кеши инвалидируются, пользователь перенаправляется на главную.

---
### S4-01 Реализация FavouriteFetcher
| Дата       | Ответственный | Статус      |
|------------|---------------|-------------|
| 2025-05-11 | Vadim         | ✅ Завершено |

**Выполнено:**
1. Создан хук `FavouriteFetcher` (`hooks/FavouriteFetcher.js`):
   - При наличии `userId` выполняет `queryClient.fetchQuery` с `queryFn`, получая из таблицы `favourites` список `location_id` для текущего пользователя.  
   - Гидрация Zustand-стора методом `hydrateFavourites(...)` на основе полученных `location_id`.  
   - При выходе пользователя (`userId = null`) сброс состояния избранного (`hydrateFavourites([])`) и очистка кеша React-Query (`removeQueries(['favourites'])`).  
2. Обновлён глобальный layout (`app/layout.jsx`):
   - Импорт и рендер `<FavouriteFetcher />` внутри провайдеров `SessionProvider` и `QueryClientProvider`.  
3. Добавлена обработка ошибок при запросах к Supabase в `fetchQuery` (try/catch + `console.error`).  

> **Acceptance Criteria:**  
> - При входе в аккаунт из Supabase загружаются все текущие `favourites` и отражаются в UI.  
> - При выходе пользователя состояние избранного очищается полностью.  
> - React-Query не выбрасывает ошибок `Missing queryFn` и успешно кэширует/инвалидирует запросы по ключу `['favourites', userId]`.  

---