# **FeatureRoadmap.md**

## Интерактивная карта избранных локаций (`/profile/map`)

> Цель — внедрить полно‑функциональную карту Leaflet, показывающую до 60 ⭐ избранных локаций текущего пользователя, полностью совместимую с существующей архитектурой Batumi Trip.&#x20;

---

### 1. Предпосылки и зависимости («Sprint 0» — 1 день)

| Шаг | Действие                                                                                                                                               | Выход                              |
| --- | ------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------- |
| 0‑1 | **Анализ кода**: сверить NewMapFeature.md с актуальным `ExistComponents.md`, убедиться в отсутствии коллизий имён, версий библиотек                    | Подтверждённая матрица зависимости |
| 0‑2 | **Обновление макроскопической документации** (`Architecture‑BatumiTrip.md`, `StateManagement‑BatumiTrip.md`) — добавить ссылку на новую страницу и хук | Pull Request #doc‑map              |
| 0‑3 | Создать ветку `feature/map-favourites` в Git                                                                                                           | Изолированная среда разработки     |

---

### 2. Изменения в базе данных и Backend (Sprint 1 — 1–2 дня)

| Шаг | Компонент                     | Задача                                                                                                                                                              | Критерий готовности                                                                       |
| --- | ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| 1‑1 | **Миграции Supabase**         | Добавить колонки `lat NUMERIC(9,6)`, `lng NUMERIC(9,6)` в `locations` + GIST‑индекс `idx_locations_coord`                                                           | Миграция применяется без даунтайма; старые записи в production остаются валидны (<null>)  |
| 1‑2 | **Edge Function `geocode()`** | Вернуть `{lat,lng}` и писать в новые поля при create/update                                                                                                         | Юнит‑тест 100 % покрытие happy‑path                                                       |
| 1‑3 | **RPC‑функции**               | Обновить `create_location_with_tags`, `update_location_with_tags` — принять `p_lat`, `p_lng`; сервис‑слой `useAddLocation`, `useUpdateLocation` передаёт координаты | Локация после сохранения содержит валидные координаты                                     |

---

### 3. Frontend — слои данных (Sprint 2 — 2 дня)

| Шаг | Файл / Хук                       | Задача                                                                                             | Критерий                                                   |
| --- | -------------------------------- | -------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- |
| 2‑1 | `hooks/useFavouriteLocations.js` | Реализовать `useQuery(['favourites', uid, filters])` (≤60 точек) со стратегией `staleTime: 60 000` | Snapshot‑тест, 200 OK, ≤ 250 ms                            |
| 2‑2 | Инвалидация кеша                 | Расширить `useToggleFavourite`, `useUpdateLocation` — `invalidateQueries(['favourites', uid])`     | Лайв‑проверка: маркер исчезает/появляется без перезагрузки |
| 2‑3 | Zustand‑селекторы                | Убедиться, что `searchQuery`, `selectedTags`, `showOnlyFavourites` доступны для карты              | eslint‑rule no‑unused‑state проходит                       |

---

### 4. Frontend — UI/UX (Sprint 3 — 3 дня)

| Шаг                                                  | Компонент                            | Ключевые детали                                                                                                                                                                                 |
| ---------------------------------------------------- | ------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 3‑1                                                  | **`LocationMap.jsx`**                | *Dynamic import* Leaflet (`{ ssr:false }`); `preferCanvas:true`; вычислять `fitBounds` из `LatLngBounds`; автосвитч тёмного тайл‑сета Carto Dark Matter, когда `<html>` содержит `class="dark"` |
| 3‑2                                                  | **Маркеры**                          | Кастомная `DivIcon` со SVG ⭐ (`lucide‑react`, 24 px); координаты → `<Marker position={[lat,lng]}>`; `cluster` плагин подключать лениво при `points.length >30`                                  |
| 3‑3                                                  | **Popup**                            | Шаблон `<h3>{title}</h3><Link href="/locations/{id}">Подробнее →</Link>`; `role="dialog"`, ловушка фокуса, Tailwind `bg-card dark:bg-card`                                                      |
| 3‑4                                                  | **Страница `/profile/map/page.jsx`** | `TagsPrefetcher`, `Header`, `dynamic(LocationMap)`; высота контейнера `h-[calc(100vh-theme(spacing.16))]` для мобайла                                                                           |
| 3‑5                                                  | **Пустые состояния**                 | • Нет избранных — компонент‑заглушка с CTA «добавить локации»                                                                                                                                   |
| • Без координат — уведомление «Отредактируйте адрес» |                                      |                                                                                                                                                                                                 |

---

### 5. Тестирование и проверка (Sprint 4 — 2 дня)

| Тип  | Инструмент                 | Проверки                                                                                                            |
| ---- | -------------------------- | ------------------------------------------------------------------------------------------------------------------- |
| Unit | Vitest + RTL               | `fitBounds`, фильтрация маркеров, скрытие `null`‑coord                                                              |
| E2E  | Cypress (десктоп + mobile) | Клик по маркеру → переход на подробную страницу; смена темы пересчитывает тайлы; фильтрация по тегу убирает маркеры |
| A11y | Lighthouse                 | Контраст поп‑апов, фокус‑кольца, атрибуция OSM присутствует                                                         |
| Perf | Chrome DevTools            | FPS > 45 на моб. Chrome при 60 маркерах; нагрузка на `tile.openstreetmap.org` ≤ 4 parallel                          |

---

### 6. Деплой и откат (Sprint 5 — 0.5 дня)

1. **Feature flag** `MAP_ENABLED=true` в `.env` — карта скрыта, пока миграции не прокатились.
2. **Supabase migration** → `vercel deploy --prebuilt` (тест‑preview).
3. Smoke‑тесты **/profile/map** на preview‑URL.
4. Flip flag в production.
5. Rollback: откат переменной + revert ветки (данные lat/lng nullable, не ломают UI).

---

### 7. Риски и меры

| Риск                               | Уровень | Митигирует                                              |
| ---------------------------------- | ------- | ------------------------------------------------------- |
| Перегрузка публичных OSM тайлов    | низкий  | Кеш‑заголовки Leaflet; параллель ≤ 4                    |
| Некорректный geocode → null coords | средний | UI‑заглушка, админ‑репорт «координаты отсутствуют»      |
| Рост > 60 маркеров                 | средний | Порог кластеризации + план миграции к server‑side tiler |

---

### 8. Check‑list закрытия фичи

* [ ] Миграции применены, индекс создан
* [ ] Edge Function `geocode()` задеплоен
* [ ] Все unit + E2E тесты ✓ в CI
* [ ] Lighthouse a11y ≥ 95
* [ ] Документация (`Readme`, `Architecture`, `API`) обновлена
* [ ] Feature flag снят, карта доступна в production

---

### 9. Файлы / модули, затрагиваемые работой

```
/supabase/migrations/20250514_add_lat_lng.sql
/supabase/functions/geocode/index.ts
/lib/uploadImage.js             (передаём lat/lng)
/hooks/useFavouriteLocations.js  (новый)
/components/LocationMap.jsx      (новый)
/app/profile/map/page.jsx        (новый)
/hooks/useToggleFavourite.js     (+invalidate)
/hooks/useUpdateLocation.js      (+lat/lng)
/ExistComponents.md              (docs patch)
```

---